<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload CSV to Firebase</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script type="module">
        import { db } from '/public/script.js';
        import { ref, set } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        function validarSKU(sku) {
            return sku.replace(/[.#$[\]]/g, '-');
        }

        function converterPreco(preco) {
            // Remove qualquer caractere não numérico (exceto ponto e vírgula) e converte para número
            const precoNumerico = parseFloat(preco.replace(',', '.').replace(/[^0-9.]/g, ''));
            
            if (!preco) {
                const novoPreco = parseFloat(0);
                return novoPreco
            } else {
                return parseFloat(precoNumerico.toFixed(2));
            }
            
        }

        function converterQuantidade(quantidade) {
            // Remove qualquer caractere não numérico e converte para número inteiro
            return parseInt(quantidade.replace(/[^0-9]/g, ''), 10);
        }

        document.getElementById('uploadCSV').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                Papa.parse(file, {
                    header: true,
                    complete: function (results) {
                        const products = results.data;
                        products.forEach(product => {
                            const productData = {
                                name: product.PRODUTO,
                                sku: validarSKU(product.SKU),
                                ean: product.EAN,
                                category: product.CATEGORIA,
                                brand: product.MARCA,
                                price: converterPreco(product.PRECO),
                                quantity: converterQuantidade(product.QUANTIDADE),
                                imageUrl: product.IMAGEM,
                                description: product.DESCRICAO
                            };

                            const newItemRef = ref(db, 'products/' + productData.sku);
                            set(newItemRef, productData)
                            .then(() => {
                                console.log('Item adicionado com sucesso!');
                            })
                            .catch((error) => {
                                console.error('Erro ao adicionar item:', error);
                            });
                        });
                    }
                });
            }
        });
    </script>
</head>
<body>
    <input type="file" id="uploadCSV" accept=".csv">
</body>
</html>
